var ie=0;function nt(e){return"$"+e.toFixed(4)}function ot(){fetch("/api/costs?limit=1").then(e=>e.json()).then(e=>{if(e.totalRequests>ie&&e.recentRequests.length>0){let t=e.recentRequests[0];console.log("%c API Cost: "+nt(t.totalCost)+" %c "+(t.action||"request")+" | "+(t.pageName||""),"background: #4a5; color: white; padding: 2px 6px; border-radius: 3px;","color: #666;"),ie=e.totalRequests}}).catch(()=>{})}function Pe(){window.setCostLoading=e=>{e||setTimeout(ot,1500)},fetch("/api/costs?limit=1").then(e=>e.json()).then(e=>{ie=e.totalRequests}).catch(()=>{})}var H=navigator.platform.toUpperCase().indexOf("MAC")>=0,st="ontouchstart"in window||navigator.maxTouchPoints>0;function Ie(e,t){let s;return(...p)=>{clearTimeout(s),s=setTimeout(()=>e(...p),t)}}function O(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function ee(e){let t=O(e);return t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.+?)__/g,"<strong>$1</strong>"),t=t.replace(/\*(.+?)\*/g,"<em>$1</em>"),t=t.replace(/_(.+?)_/g,"<em>$1</em>"),t=t.replace(/`(.+?)`/g,"<code>$1</code>"),t=t.replace(/\n/g,"<br>"),t}function a(e){return document.getElementById(e)}function De(){document.querySelectorAll(".shortcut-hint").forEach(t=>{if(st)t.style.display="none";else{let s=H?t.dataset.mac:t.dataset.other;t.textContent=s||""}})}function ce(e,t){e.addEventListener("keydown",s=>{(H?s.metaKey:s.ctrlKey)&&s.key==="Enter"&&(s.preventDefault(),t())})}var A,Be,le,B,me,ue,$e,de,V,Re,fe,te,_,J,$,Fe,qe,r={sidebarOpen:localStorage.getItem("delve-sidebar")!=="false",sortMode:localStorage.getItem("delve-sort")||"recent",favorites:JSON.parse(localStorage.getItem("delve-favorites")||"[]"),searchQuery:"",pages:[],currentSlug:"",currentProject:"",projects:[],projectDropdownOpen:!1,projectCreateMode:!1};function N(){localStorage.setItem("delve-sidebar",String(r.sidebarOpen)),localStorage.setItem("delve-sort",r.sortMode),localStorage.setItem("delve-favorites",JSON.stringify(r.favorites))}function Y(){A.dataset.open=String(r.sidebarOpen),document.body.dataset.sidebarOpen=String(r.sidebarOpen)}function pe(){r.sidebarOpen=!r.sidebarOpen,Y(),N()}function Ne(){me.forEach(e=>{e.classList.toggle("active",e.dataset.sort===r.sortMode)})}function rt(e){r.sortMode=e,Ne(),N(),W()}function at(e,t){let s=r.favorites.indexOf(e);if(s>=0?r.favorites.splice(s,1):r.favorites.push(e),t){t.classList.toggle("active",r.favorites.includes(e));let p=t.querySelector("svg");p&&(p.style.animation="none",p.offsetHeight,p.style.animation="star-pop 0.3s ease")}N(),W()}function it(e){r.searchQuery=e.toLowerCase(),W()}function ct(){let e=[...r.pages];return r.searchQuery&&(e=e.filter(t=>t.title.toLowerCase().includes(r.searchQuery)||t.slug.toLowerCase().includes(r.searchQuery))),r.sortMode==="alpha"?e.sort((t,s)=>t.title.localeCompare(s.title)):e.sort((t,s)=>s.modifiedAt-t.modifiedAt),e}function Oe(e){let t=e.slug===r.currentSlug,s=r.favorites.includes(e.slug);return`
    <li class="page-item${t?" active":""}" data-slug="${e.slug}">
      <a href="/p/${r.currentProject}/wiki/${e.slug}">
        <span class="page-title">${e.title}</span>
      </a>
      <button class="favorite-btn${s?" active":""}" data-slug="${e.slug}" aria-label="${s?"Remove from":"Add to"} favorites">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="${s?"currentColor":"none"}">
          <path d="M7 1.5L8.5 5L12.5 5.5L9.5 8L10.5 12L7 10L3.5 12L4.5 8L1.5 5.5L5.5 5L7 1.5Z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/>
        </svg>
      </button>
    </li>
  `}function W(){let e=ct(),t=r.searchQuery?e:e.filter(p=>!r.favorites.includes(p.slug));ue.innerHTML=t.length>0?t.map(p=>Oe(p)).join(""):'<li class="empty-state">No pages found</li>';let s=r.pages.filter(p=>r.favorites.includes(p.slug));s.length>0&&!r.searchQuery?(de.style.display="",$e.innerHTML=s.map(p=>Oe(p)).join("")):de.style.display="none",document.querySelectorAll(".favorite-btn").forEach(p=>{p.onclick=v=>{v.preventDefault(),v.stopPropagation(),at(p.dataset.slug,p)}})}function lt(){te&&(te.innerHTML=r.projects.map(e=>`
    <button class="project-item${e===r.currentProject?" active":""}" data-project="${e}">
      <span class="project-icon">\u{1F4C1}</span>
      <span class="project-name">${e}</span>
      ${e===r.currentProject?'<span class="check-icon">\u2713</span>':""}
    </button>
  `).join(""),te.querySelectorAll(".project-item").forEach(e=>{e.onclick=()=>{let t=e.dataset.project;t!==r.currentProject?window.location.href="/p/"+t:Ke()}}))}function dt(){r.projectDropdownOpen=!r.projectDropdownOpen,fe?.classList.toggle("open",r.projectDropdownOpen),V?.classList.toggle("open",r.projectDropdownOpen),r.projectDropdownOpen||ne()}function Ke(){r.projectDropdownOpen=!1,fe?.classList.remove("open"),V?.classList.remove("open"),ne()}function pt(){r.projectCreateMode=!0,_&&(_.style.display="none"),J&&(J.style.display="block"),$&&($.value="",$.focus())}function ne(){r.projectCreateMode=!1,_&&(_.style.display="flex"),J&&(J.style.display="none"),$&&($.value="")}async function Ae(){let e=$?.value.trim();if(e)try{let s=await(await fetch("/api/projects",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({name:e})})).json();if(s.error){alert("Error: "+s.error);return}window.location.href="/p/"+s.project}catch(t){alert("Failed to create project: "+t.message)}}function mt(){Re?.addEventListener("click",e=>{e.stopPropagation(),dt()}),_?.addEventListener("click",e=>{e.stopPropagation(),pt()}),Fe?.addEventListener("click",e=>{e.stopPropagation(),ne()}),qe?.addEventListener("click",e=>{e.stopPropagation(),Ae()}),$?.addEventListener("keydown",e=>{e.key==="Enter"?(e.preventDefault(),Ae()):e.key==="Escape"&&ne()}),document.addEventListener("click",e=>{r.projectDropdownOpen&&V&&!V.contains(e.target)&&Ke()})}function ut(e){let t=H?e.metaKey:e.ctrlKey;if(t&&e.key==="k"&&(e.preventDefault(),r.sidebarOpen||(r.sidebarOpen=!0,Y(),N()),B?.focus(),B?.select()),t&&e.key==="\\"&&(e.preventDefault(),pe()),t&&e.key==="p"&&(e.preventDefault(),window.location.href="/p/"+r.currentProject),e.key==="Escape"&&(B&&document.activeElement===B&&r.searchQuery?(r.searchQuery="",B.value="",W()):r.sidebarOpen&&window.innerWidth<=768&&(r.sidebarOpen=!1,Y(),N())),(e.key==="ArrowDown"||e.key==="ArrowUp")&&document.activeElement===B){e.preventDefault();let s=ue.querySelectorAll(".page-item a");s.length>0&&s[0].focus()}}function ft(){Be?.addEventListener("click",pe),le?.addEventListener("click",pe),me.forEach(t=>{t.addEventListener("click",()=>rt(t.dataset.sort))});let e=Ie(t=>it(t),150);B?.addEventListener("input",t=>e(t.target.value)),document.addEventListener("keydown",ut),document.addEventListener("click",t=>{window.innerWidth<=768&&r.sidebarOpen&&!A.contains(t.target)&&t.target!==le&&(r.sidebarOpen=!1,Y(),N())})}function _e(){if(A=document.getElementById("sidebar"),!A)return;Be=document.getElementById("sidebar-toggle"),le=document.getElementById("sidebar-expand"),B=document.getElementById("search-input"),me=document.querySelectorAll(".sort-btn"),ue=document.getElementById("pages-list"),$e=document.getElementById("favorites-list"),de=document.getElementById("favorites-section"),V=document.getElementById("project-selector"),Re=document.getElementById("project-current"),fe=document.getElementById("project-dropdown"),te=document.getElementById("project-list"),_=document.getElementById("project-create-btn"),J=document.getElementById("project-create-form"),$=document.getElementById("project-create-input"),Fe=document.getElementById("project-create-cancel"),qe=document.getElementById("project-create-submit");try{r.pages=JSON.parse(A.dataset.pages||"[]"),r.currentSlug=A.dataset.currentSlug||"",r.currentProject=A.dataset.project||"default",r.projects=JSON.parse(A.dataset.projects||'["default"]')}catch{r.pages=[],r.projects=["default"]}let e=new Set(r.pages.map(t=>t.slug));r.favorites=r.favorites.filter(t=>e.has(t)),N(),De(),Y(),Ne(),W(),lt(),ft(),mt(),window.addEventListener("pageshow",t=>{t.persisted&&location.reload()})}function Qe(){let e=a("settings-form");if(!e)return;let t=a("save-btn"),s=a("save-status"),p=a("system-prompt");!t||!s||!p||(p.addEventListener("keydown",v=>{(H?v.metaKey:v.ctrlKey)&&v.key==="Enter"&&(v.preventDefault(),e.requestSubmit())}),e.addEventListener("submit",async v=>{v.preventDefault(),t.disabled=!0,t.innerHTML='<span class="spinner"></span> Saving...',s.textContent="";try{let h=new FormData(e),E=await(await fetch("/settings",{method:"POST",body:h})).json();E.success?(s.textContent="Saved!",s.className="save-status success"):(s.textContent="Error: "+(E.error||"Failed to save"),s.className="save-status error")}catch(h){s.textContent="Error: "+h.message,s.className="save-status error"}finally{t.disabled=!1,t.textContent="Save Settings"}}))}function Ue(){let e=a("generate-form");if(!e)return;let t=a("generate-section"),s=a("streaming-section"),p=a("streaming-content"),v=a("topic"),h=e.dataset.project;!t||!s||!p||!v||(v.addEventListener("keydown",w=>{(H?w.metaKey:w.ctrlKey)&&w.key==="Enter"&&(w.preventDefault(),e.requestSubmit())}),e.addEventListener("submit",async w=>{w.preventDefault();let E=v.value.trim();if(!E)return;t.style.display="none",s.style.display="block",p.innerHTML="";let b=await import("https://cdn.jsdelivr.net/npm/streaming-markdown/smd.min.js"),R=b.default_renderer(p),L=b.parser(R);try{window.setCostLoading?.(!0);let K=(await fetch("/p/"+h+"/generate",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({topic:E})})).body.getReader(),F=new TextDecoder,x="";for(;;){let{done:y,value:M}=await K.read();if(y)break;x+=F.decode(M,{stream:!0});let X=x.split(`
`);x=X.pop()||"";for(let G of X)if(G.startsWith("data: "))try{let C=JSON.parse(G.slice(6));C.content&&b.parser_write(L,C.content),C.url&&(window.setCostLoading?.(!1),b.parser_end(L),setTimeout(()=>{window.location.href=C.url},500)),C.message&&(window.setCostLoading?.(!1),p.innerHTML='<p class="error">Error: '+C.message+"</p>")}catch{}}}catch(T){window.setCostLoading?.(!1),p.innerHTML='<p class="error">Connection error: '+T.message+"</p>"}}))}async function Ve(){let e=a("streaming-section");if(!e||!e.dataset.topic)return;let t=a("streaming-content"),s=e.dataset.topic,p=e.dataset.project;if(!t||!s)return;let v=await import("https://cdn.jsdelivr.net/npm/streaming-markdown/smd.min.js"),h=v.default_renderer(t),w=v.parser(h);try{window.setCostLoading?.(!0);let b=(await fetch("/p/"+p+"/generate",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({topic:s})})).body.getReader(),R=new TextDecoder,L="";for(;;){let{done:T,value:K}=await b.read();if(T)break;L+=R.decode(K,{stream:!0});let F=L.split(`
`);L=F.pop()||"";for(let x of F)if(x.startsWith("data: "))try{let y=JSON.parse(x.slice(6));y.content&&v.parser_write(w,y.content),y.url&&(window.setCostLoading?.(!1),v.parser_end(w),setTimeout(()=>{window.location.replace(y.url)},500)),y.message&&(window.setCostLoading?.(!1),t.innerHTML='<p class="error">Error: '+y.message+"</p>")}catch{}}}catch(E){window.setCostLoading?.(!1),t.innerHTML='<p class="error">Connection error: '+E.message+"</p>"}}function Je(){let e=a("page-data");if(!e)return;let t=e.dataset.slug,s=e.dataset.project,p=JSON.parse(e.dataset.inlineComments||"[]");document.addEventListener("keydown",o=>{let n=H?o.metaKey:o.ctrlKey,i=o.target;if(n&&o.key==="Enter"&&i.tagName==="TEXTAREA"){let d=a("popover-textarea");if(i===d){o.preventDefault();let c=a("popover-submit"),m=document.querySelector(".btn-submit-inline");c?c.click():m&&m.click()}let l=i.closest(".reply-form");if(l){o.preventDefault();let c=l.querySelector(".btn-submit-reply");c&&c.click()}}});let v=document.querySelectorAll(".chat-tab"),h={comment:a("tab-comment"),edit:a("tab-edit")};v.forEach(o=>{o.addEventListener("click",()=>{v.forEach(i=>i.classList.remove("active")),o.classList.add("active");let n=o.dataset.tab;Object.keys(h).forEach(i=>{h[i]?.classList.toggle("hidden",i!==n)})})});let w=a("edit-form"),E=a("edit-message"),b=a("edit-submit");w&&E&&b&&(w.addEventListener("submit",()=>{b.disabled=!0,b.innerHTML='<span class="spinner"></span> Updating...'}),ce(E,()=>w.requestSubmit()));let R=a("comment-form"),L=a("comment-message"),T=a("comment-submit");R&&L&&T&&(ce(L,()=>R.requestSubmit()),R.addEventListener("submit",async o=>{o.preventDefault();let n=L.value.trim();if(n){L.disabled=!0,T.disabled=!0,T.innerHTML='<span class="spinner"></span> Sending...';try{let i=new FormData;i.append("message",n),window.setCostLoading?.(!0);let d=await fetch("/p/"+s+"/wiki/"+t+"/comment",{method:"POST",body:i});window.setCostLoading?.(!1);let l=await d.json();l.success?window.location.reload():alert("Error: "+l.error)}catch(i){window.setCostLoading?.(!1),alert("Error: "+i.message)}finally{L.disabled=!1,T.disabled=!1,T.textContent="Ask"}}})),document.addEventListener("click",async o=>{let n=o.target;if(n.classList.contains("btn-reply")){let i=n.dataset.threadId,d=document.querySelector('.reply-form[data-thread-id="'+i+'"]');d&&(d.classList.remove("hidden"),d.querySelector("textarea")?.focus())}if(n.classList.contains("btn-cancel-reply")&&n.closest(".reply-form")?.classList.add("hidden"),n.classList.contains("btn-submit-reply")){let i=n.dataset.threadId,d=n.dataset.endpoint,m=n.closest(".reply-form")?.querySelector("textarea")?.value.trim();if(!m)return;n.disabled=!0,n.innerHTML='<span class="spinner"></span>';try{let u=new FormData;u.append("message",m),window.setCostLoading?.(!0);let f=await fetch("/p/"+s+"/wiki/"+t+"/"+d+"/"+i+"/reply",{method:"POST",body:u});window.setCostLoading?.(!1);let g=await f.json();g.success?window.location.reload():alert("Error: "+g.error)}catch(u){window.setCostLoading?.(!1),alert("Error: "+u.message)}}if(n.classList.contains("btn-resolve")){let i=n.dataset.threadId,d=n.dataset.endpoint,l=n.dataset.resolved==="true";try{let c=new FormData;c.append("resolved",l?"false":"true");let u=await(await fetch("/p/"+s+"/wiki/"+t+"/"+d+"/"+i+"/resolve",{method:"POST",body:c})).json();u.success?window.location.reload():alert("Error: "+u.error)}catch(c){alert("Error: "+c.message)}}});let K=a("selection-toolbar"),F=a("btn-comment"),x=a("btn-edit"),y=a("wiki-content");if(!K||!F||!x||!y)return;let M=K,X=F,G=x,C=y,q=null,P=null;function We(o,n=30,i=30){let d=o.toString(),l=o.commonAncestorContainer,c=l.textContent||"",m=o.startOffset,u=o.endOffset,f="",g="";if(l.nodeType===Node.TEXT_NODE){let j=Math.max(0,m-n);f=c.slice(j,m),g=c.slice(u,u+i)}return{text:d,prefix:f,suffix:g}}document.addEventListener("mouseup",o=>{if(o.target.closest(".selection-toolbar")||o.target.closest(".inline-popover"))return;let n=window.getSelection(),i=n?.toString().trim();if(i&&i.length>0&&n&&C.contains(n.anchorNode)){q=i,P=n.getRangeAt(0).cloneRange();let d=n.getRangeAt(0).getBoundingClientRect();M.style.top=window.scrollY+d.top-40+"px",M.style.left=window.scrollX+d.left+d.width/2-M.offsetWidth/2+"px",M.classList.remove("hidden")}else setTimeout(()=>{M.matches(":hover")||M.classList.add("hidden")},100)});let ve=a("inline-popover"),ge=a("popover-selection"),we=a("popover-body");if(!ve||!ge||!we)return;let S=ve,oe=ge,I=we,Q=null;function Ee(o,n){Q=o;let i=q.length>100?q.slice(0,100)+"...":q;oe.textContent='"'+i+'"',o==="comment"?I.innerHTML=`
        <textarea id="popover-textarea" placeholder="Ask about this..." rows="3"></textarea>
        <div class="popover-buttons">
          <button class="btn-cancel" id="popover-cancel">Cancel</button>
          <button class="btn-submit" id="popover-submit">Ask</button>
        </div>
      `:I.innerHTML=`
        <textarea id="popover-textarea" placeholder="What change would you like?" rows="3"></textarea>
        <div class="popover-buttons">
          <button class="btn-cancel" id="popover-cancel">Cancel</button>
          <button class="btn-submit" id="popover-submit">Apply</button>
        </div>
      `,S.style.top=window.scrollY+n.bottom+10+"px",S.style.left=window.scrollX+n.left+"px",S.classList.remove("hidden"),M.classList.add("hidden"),a("popover-textarea")?.focus()}function U(){S.classList.add("hidden"),q=null,P=null,Q=null}function Xe(o,n){let i=n.length>100?n.slice(0,100)+"...":n;oe.textContent='"'+i+'"';let d=o.messages.map(c=>`
      <div class="popover-message popover-message-${c.role}">
        <strong>${c.role==="user"?"You":"AI"}:</strong>
        <span class="message-content">${c.role==="assistant"?ee(c.content):O(c.content)}</span>
      </div>
    `).join("");I.innerHTML=`
      <div class="popover-thread" id="popover-thread">
        ${d}
      </div>
      <div class="popover-reply-form">
        <textarea id="popover-textarea" placeholder="Reply..." rows="2"></textarea>
        <div class="popover-buttons">
          <button class="btn-submit-inline" data-comment-id="${o.id}">Reply</button>
        </div>
      </div>
    `;let l=a("popover-thread");l&&(l.scrollTop=l.scrollHeight),p.push(o),Q="view-inline"}X.addEventListener("click",()=>{if(!P)return;let o=P.getBoundingClientRect();Ee("comment",o)}),G.addEventListener("click",()=>{if(!P)return;let o=P.getBoundingClientRect();Ee("edit",o)}),I.addEventListener("click",async o=>{let n=o.target;if(n.id==="popover-cancel"&&U(),n.id==="popover-submit"){let d=a("popover-textarea")?.value.trim();if(!d||!q)return;n.disabled=!0,n.innerHTML='<span class="spinner"></span>';try{let l=We(P);if(Q==="comment")try{let c=d;I.innerHTML=`
              <div class="popover-thread">
                <div class="popover-message popover-message-user">
                  <strong>You:</strong> ${O(c)}
                </div>
                <div class="popover-message popover-message-assistant loading">
                  <strong>AI:</strong> <span class="spinner"></span> Thinking...
                </div>
              </div>
            `;let m=new FormData;m.append("message",d),m.append("text",l.text),m.append("prefix",l.prefix),m.append("suffix",l.suffix),window.setCostLoading?.(!0);let u=await fetch("/p/"+s+"/wiki/"+t+"/inline",{method:"POST",body:m});window.setCostLoading?.(!1);let f=await u.json();if(f.success&&f.thread){Xe(f.thread,l.text);let g=P;if(g){let j=document.createElement("mark");j.className="inline-comment",j.dataset.commentId=f.thread.id;try{g.surroundContents(j)}catch{window.location.reload()}}}else alert("Error: "+(f.error||"Unknown error")),U()}catch(c){console.error("Error in comment flow:",c),alert("Error: "+c.message)}else{I.innerHTML='<div class="edit-streaming"><div class="spinner"></div> Editing...</div>';let c=new FormData;c.append("instruction",d),c.append("text",l.text),window.setCostLoading?.(!0);let u=(await fetch("/p/"+s+"/wiki/"+t+"/inline-edit",{method:"POST",body:c})).body.getReader(),f=new TextDecoder,g="";for(;;){let{done:j,value:k}=await u.read();if(j)break;g+=f.decode(k,{stream:!0});let je=g.split(`
`);g=je.pop()||"";for(let ke of je)if(ke.startsWith("data: "))try{let ae=JSON.parse(ke.slice(6));ae.success&&(window.setCostLoading?.(!1),window.location.reload()),ae.message&&(window.setCostLoading?.(!1),alert("Error: "+ae.message),U())}catch{}}}}catch(l){window.setCostLoading?.(!1),alert("Error: "+l.message),U()}}}),document.addEventListener("mousedown",o=>{!S.classList.contains("hidden")&&!S.contains(o.target)&&!M.contains(o.target)&&U()}),C.addEventListener("click",o=>{let n=o.target.closest(".inline-comment");if(!n)return;let i=n.dataset.commentId,d=p.find(u=>u.id===i);if(!d)return;q=d.anchor.text;let l=n.getBoundingClientRect();oe.textContent='"'+(d.anchor.text.length>100?d.anchor.text.slice(0,100)+"...":d.anchor.text)+'"';let c=d.messages.map(u=>`
      <div class="popover-message popover-message-${u.role}">
        <strong>${u.role==="user"?"You":"AI"}:</strong>
        <span class="message-content">${u.role==="assistant"?ee(u.content):O(u.content)}</span>
      </div>
    `).join("");I.innerHTML=`
      <div class="popover-thread" id="popover-thread">
        ${c}
      </div>
      <div class="popover-reply-form">
        <textarea id="popover-textarea" placeholder="Reply..." rows="2"></textarea>
        <div class="popover-buttons">
          <button class="btn-submit-inline" data-comment-id="${i}">Reply</button>
        </div>
      </div>
    `,S.style.top=window.scrollY+l.bottom+10+"px",S.style.left=window.scrollX+l.left+"px",S.classList.remove("hidden");let m=a("popover-thread");m&&(m.scrollTop=m.scrollHeight),Q="view-inline"}),I.addEventListener("click",async o=>{let n=o.target;if(n.classList.contains("btn-submit-inline")){let i=n.dataset.commentId,d=a("popover-textarea"),l=d?.value.trim();if(!l)return;n.disabled=!0,n.innerHTML='<span class="spinner"></span>';let c=a("popover-thread");c&&(c.innerHTML+=`
          <div class="popover-message popover-message-user">
            <strong>You:</strong>
            <span class="message-content">${O(l)}</span>
          </div>
          <div class="popover-message popover-message-assistant loading">
            <strong>AI:</strong> <span class="spinner"></span> Thinking...
          </div>
        `,c.scrollTop=c.scrollHeight),d&&(d.value="");try{let m=new FormData;m.append("message",l),window.setCostLoading?.(!0);let u=await fetch("/p/"+s+"/wiki/"+t+"/inline/"+i+"/reply",{method:"POST",body:m});window.setCostLoading?.(!1);let f=await u.json();if(f.success&&f.thread){let g=p.find(k=>k.id===i);g&&(g.messages=f.thread.messages);let j=f.thread.messages.map(k=>`
            <div class="popover-message popover-message-${k.role}">
              <strong>${k.role==="user"?"You":"AI"}:</strong>
              <span class="message-content">${k.role==="assistant"?ee(k.content):O(k.content)}</span>
            </div>
          `).join("");c&&(c.innerHTML=j,c.scrollTop=c.scrollHeight),n.disabled=!1,n.textContent="Reply"}else alert("Error: "+(f.error||"Unknown error")),window.location.reload()}catch(m){window.setCostLoading?.(!1),alert("Error: "+m.message),window.location.reload()}}});let Le=a("version-list"),he=a("version-preview-modal"),ye=a("preview-content"),be=a("preview-version-num"),Te=a("preview-revert"),Me=a("show-all-versions");if(!Le||!he||!ye||!be||!Te||!Me)return;let Z=Le,He=he,Ge=ye,Ze=be,z=Te,ze=Me,se=1,xe=!1;function et(o){return new Date(o).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}async function Ce(){try{let o=xe?"/p/"+s+"/wiki/"+t+"/history?all=true":"/p/"+s+"/wiki/"+t+"/history",i=await(await fetch(o)).json();if(!i.versions||i.versions.length===0){Z.innerHTML='<p class="no-versions">No version history yet.</p>';return}se=i.currentVersion;let d=i.versions.map(l=>{let c=l.version===se,m=!!l.supersededAt,u=l.editPrompt?O(l.editPrompt.slice(0,60))+(l.editPrompt.length>60?"...":""):"(Initial generation)",f=["version-item"];return c&&f.push("version-current"),m&&f.push("version-superseded"),`
          <div class="${f.join(" ")}" data-version="${l.version}">
            <div class="version-header">
              <span class="version-number">v${l.version}</span>
              <span class="version-timestamp">${et(l.timestamp)}</span>
              ${c?'<span class="version-badge">Current</span>':""}
              ${m?'<span class="version-badge version-badge-superseded">Reverted</span>':""}
            </div>
            <div class="version-prompt">${u}</div>
            <div class="version-actions">
              <button class="btn-preview-version" data-version="${l.version}">Preview</button>
              ${c?"":`<button class="btn-revert-version" data-version="${l.version}">${m?"Restore":"Revert"}</button>`}
            </div>
          </div>
        `}).join("");Z.innerHTML=d}catch(o){Z.innerHTML='<p class="error">Failed to load version history</p>',console.error("Failed to load version history:",o)}}ze.addEventListener("change",o=>{xe=o.target.checked,Ce()});async function tt(o){try{let i=await(await fetch("/p/"+s+"/wiki/"+t+"/version/"+o)).json();Ze.textContent=String(o),Ge.innerHTML=i.html,z.dataset.version=String(o),z.style.display=o===se?"none":"inline-block",He.classList.remove("hidden")}catch(n){alert("Failed to load version preview"),console.error("Failed to load version:",n)}}async function Se(o){if(confirm("Revert to version "+o+"? Later versions will be hidden but can be recovered."))try{let n=new FormData;n.append("version",String(o));let d=await(await fetch("/p/"+s+"/wiki/"+t+"/revert",{method:"POST",body:n})).json();d.success?window.location.reload():alert("Error: "+d.error)}catch(n){alert("Error reverting: "+n.message)}}function re(){He.classList.add("hidden")}Z.addEventListener("click",o=>{let n=o.target;n.classList.contains("btn-preview-version")&&tt(parseInt(n.dataset.version)),n.classList.contains("btn-revert-version")&&Se(parseInt(n.dataset.version))}),a("modal-close")?.addEventListener("click",re),a("preview-cancel")?.addEventListener("click",re),a("modal-backdrop")?.addEventListener("click",re),z.addEventListener("click",()=>{Se(parseInt(z.dataset.version))}),Ce();let D=a("btn-delete-page");D&&D.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete this page?

This will permanently delete:
- All page content
- All comments
- All version history

This action cannot be undone.`)){D.disabled=!0,D.textContent="Deleting...";try{let i=await(await fetch("/p/"+s+"/wiki/"+t+"/delete",{method:"POST"})).json();i.success?window.location.href="/p/"+s:(alert("Error: "+(i.error||"Failed to delete page")),D.disabled=!1,D.textContent="Delete Page")}catch(n){alert("Error: "+n.message),D.disabled=!1,D.textContent="Delete Page"}}})}function Ye(){Pe(),_e(),Qe(),Ue(),Ve(),Je()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ye):Ye();
